
let fpl_logo = `<svg xmlns="http://www.w3.org/2000/svg" width="192"  viewBox="0 0 453 104" id="ism-game-title" class="App__HeadlineLogo-sc-1g9np4c-2 ibSWdl"><title>Fantasy</title><path fill="#37003C" d="M14.616562 7.93010475C17.2559993 9.1695844 19.7212401 10.755045 21.9482465 12.6453022 21.7227217 11.5736664 20.9057261 6.34837034 20.4248901 3.09917067 22.854601 4.81378791 28.5097425 8.74454794 30.3479826 10.0262243 31.1096608 7.6771987 33.730855 0 33.730855 0 33.730855 0 38.4626212 7.71577759 39.2711065 9.00174052 40.2583095 7.96011055 45.9177061 1.62031329 47.3814899 0 47.6282907 3.64784818 47.9644503 8.86885769 48.0410437 9.65329507 49.7771569 7.29275354 51.8259026 5.18275834 54.130214 3.38208251 52.5557954 6.50697243 51.8068828 10.8192348 51.4664679 14.2827616 40.7926673 11.2796783 29.3710353 12.6833891 19.7270397 18.1835159 18.6249467 14.8400122 16.9015966 10.6777789 14.616562 7.93010475ZM71.7126403 73.7671203 68.4276371 70.102126C67.4872411 80.0083271 62.6746264 88.4228112 53.8238407 94.2868022L52.4792021 88.9414829C44.9687998 94.4111119 32.0798431 97.9432234 21.0121057 91.6462916 22.3822754 84.5820686 23.6035137 77.4235416 20.9823194 68.8504554 14.8548524 78.413733 9.42523576 82.138739 9.42523576 82.138739 5.28919551 75.1345276 5.65939664 61.0746662 6.89340042 56.9381521L0 59.1114294C0 54.396232 3.37861724 44.3657211 8.26357013 38.7417766L3.95732246 38.0473566 3.95732246 38.0473566C6.87650719 32.0407286 11.2164296 26.8489079 16.5952232 22.9287191L16.5952232 22.9287191C14.9910183 25.5006449 14.9654872 31.7847171 19.6717223 34.1808947 17.6717851 30.6573563 17.4334948 26.3022285 19.5142804 24.0432203 21.5950661 21.7842121 25.1055941 22.5472167 27.352332 24.3132725 26.6842679 22.3457492 24.7311378 19.8681273 21.820591 19.7009521L21.820591 19.7009521C27.5187347 16.7503825 33.8344371 15.2145669 40.2412887 15.2214911 41.4838029 15.2214911 42.7107147 15.2772396 43.9220241 15.3886898L43.9220241 15.3886898C45.8538783 16.1688406 48.6878318 18.9122282 50.0111945 20.6139858 49.9988376 19.0793195 49.6516434 17.5661629 48.9942052 16.1817002 56.1854686 17.9391829 59.6321688 20.8968976 61.0491456 22.3157434 61.3427534 25.4406333 62.274639 27.3181392 63.5043876 30.2972867 61.1768011 27.6653492 55.321666 23.4388177 52.5302643 22.4100474 52.5302643 22.4100474 52.3004843 25.1234291 51.3430676 26.4308248 45.7815402 22.3843281 43.0454559 21.3727039 43.0454559 21.3727039 36.9350097 22.2300125 33.0117287 24.6261901 30.8798808 26.4908364L32.7351416 28.0811439C29.0544062 29.2256509 26.662992 32.414839 26.662992 32.414839 26.662992 32.414839 29.9522503 32.9377972 29.9522503 32.9377972 29.9522503 32.9377972 29.6203459 36.795686 34.4201951 39.2218694 38.526449 41.2922697 44.4411568 38.7203439 50.0069393 40.970779 46.3432247 36.7142417 43.8284101 34.8110166 43.8284101 34.8110166 43.0113529 34.641457 42.1814123 34.5425069 41.347637 34.5152451 40.0710813 34.5152451 38.1690134 34.7767242 36.0754622 33.9579945 35.0034307 33.495767 33.9739446 32.9392191 32.9989631 32.2948158 34.7481651 30.6161306 36.9457916 29.4883629 39.3221687 29.0499026 41.4855465 29.7075734 43.5320452 30.7058121 45.3858079 32.0076174 46.340026 30.9887833 47.644438 30.3754696 49.0325019 30.2930001 49.0325019 30.2930001 47.1900066 32.0076174 47.7559462 34.1508889 49.7290487 35.9907912 51.5945353 37.9444501 53.3430047 40.0020203 56.3216345 38.3645608 62.7384542 38.7417766 64.0575617 40.2849321 62.3852738 38.0987951 59.9683285 36.2727278 58.100302 34.7124261 57.8747772 33.8936963 55.8365434 31.0345721 55.4918734 30.773093 56.8415406 31.2398001 58.0875806 31.9678874 59.1598432 32.9163645 59.8253594 32.0296705 60.7785346 31.4062235 61.8533756 31.1545953 62.7464878 31.9337793 63.2883539 33.0440541 63.3554561 34.2323332 63.0311711 34.6324129 62.635798 34.9681948 62.1895353 35.2225247L65.3213517 38.6517592 65.6362355 36.1998565C72.8402644 46.5947236 76.7805661 58.6313366 71.7126403 73.7671203ZM58.0960469 51.3827922 58.0960469 46.0117537C56.3197297 45.3581775 54.6568118 44.4265618 53.1685421 43.2512199 48.0623196 44.0313708 41.87528 49.2095149 41.87528 49.2095149 41.87528 49.2095149 43.9688312 53.204573 46.2496106 57.5125489 50.2622505 58.0697995 56.1684479 52.9645266 58.0917917 51.3827922L58.0960469 51.3827922ZM63.2320557 61.1218181C62.8600416 59.5410305 62.120622 58.0718616 61.0746767 56.835275L57.0918231 56.9338655C57.0918231 56.9338655 51.7175239 61.5890513 48.4367759 61.6962149 48.4367759 61.6962149 50.2452297 65.082584 51.1515842 66.8400667 52.960038 66.4457047 56.1344064 65.0097127 57.410962 63.5137092 57.9518869 65.4652173 58.1831034 67.4906114 58.0960469 69.5148696 59.8832247 68.4432338 62.3639979 65.6055422 63.2278005 61.1218181L63.2320557 61.1218181ZM64.8703021 43.4698336C63.7119048 44.4613453 62.468813 45.3478196 61.1555252 46.1189173L61.1555252 51.5113885C62.5980331 53.1274153 64.0150098 54.4691032 65.0788062 56.9038597 67.1042744 53.2560115 66.7213078 47.8806865 64.8660469 43.4698336L64.8703021 43.4698336ZM247.753734 53.4622366 247.753734 82.7965634 235.200236 82.7965634 235.200236 54.8190351C235.200236 46.6868315 231.341578 42.5262691 224.854747 42.5262691 217.510436 42.5262691 212.386996 47.7516607 212.386996 58.6919219L212.386996 82.7965634 199.807774 82.7965634 199.807774 31.5130156 211.019317 31.5130156 212.275524 37.7044821C215.951252 33.0587354 220.977511 30.7358229 227.354299 30.7358229 239.826337 30.7143937 247.753734 39.5249965 247.753734 53.4622366ZM273.070813 16.6783992 273.070813 31.5130156 291.339411 31.5130156 291.339411 42.6207298 273.070813 42.6207298 273.070813 64.5957128C273.070813 69.3187455 275.291684 71.7575478 280.029258 71.7575478 283.038885 71.673238 285.985935 70.8772834 288.629776 69.4346745L292.788551 79.9885057C288.423751 82.3476345 283.540021 83.5784693 278.580118 83.5694728 267.364287 83.5694728 260.504452 77.0816938 260.504452 66.4376956L260.504452 42.6207298 252.2898 42.6207298 252.2898 31.5130156 260.495878 31.5130156 260.495878 16.6783992 273.070813 16.6783992ZM348.554723 31.5130156 348.554723 82.7965634 337.34318 82.7965634 336.086973 76.8884788C332.228316 81.0533349 326.418893 83.5694232 319.751991 83.5694232 305.350624 83.5694232 295.103746 72.6291621 295.103746 57.1419085 295.103746 41.5559006 305.350624 30.7143937 319.751991 30.7143937 326.418893 30.7143937 332.219741 33.230482 336.086973 37.3953381L337.34318 31.5130156 348.554723 31.5130156ZM335.988363 57.6485611 335.988363 56.6781925C335.988363 47.4854534 329.128528 42.3545225 321.779929 42.3545225 313.565277 42.3545225 307.670106 48.7434976 307.670106 57.1633768 307.670106 65.583256 313.565277 71.9722311 321.779929 71.9722311 329.12424 71.9507628 335.988363 66.8241255 335.988363 57.6270927L335.988363 57.6485611ZM360.503698 68.296853C364.215522 71.2585526 368.808872 72.8936617 373.554535 72.9425997 378.270671 72.9425997 381.091779 71.3925862 381.091779 68.5845286 381.091779 60.4566187 356.156278 64.0375362 356.156278 46.2231156 356.156278 37.0303765 363.792132 30.735862 375.196608 30.735862 381.657137 30.6840068 387.961902 32.7214076 393.173663 36.5451922L386.974087 45.9139716C383.299788 43.0114534 379.141013 41.3626856 374.969376 41.3626856 370.797739 41.3626856 368.688339 43.0114534 368.688339 45.3343267 368.688339 52.8825917 393.62384 49.3016742 393.62384 67.5969854 393.62384 77.0816938 385.50351 83.5694232 373.228693 83.5694232 366.368857 83.5694232 359.791991 81.7317342 354.865771 78.5372466L360.503698 68.296853ZM453 31.5130156 431.640188 85.6990816C426.225206 99.4388131 418.589352 103.994393 407.279199 103.994393 405.482973 104.039635 403.69033 103.810883 401.962827 103.315994L403.6049 90.8300126C404.688705 91.0360107 405.790244 91.1338128 406.893333 91.1219819 412.895689 91.1219819 416.557126 89.3787535 418.975218 83.4706689L395.977621 31.5130156 409.993121 31.5130156 425.749305 68.0091773 439.28033 31.5130156 453 31.5130156ZM102.055124 28.1983054 102.055124 43.6855589 131.535265 43.6855589 131.535265 55.8838643 102.055124 55.8838643 102.055124 82.7965634 89 82.7965634 89 16 135.110954 16 135.110954 28.1983054 102.055124 28.1983054ZM190.881413 31.5130156 190.881413 82.7965634 179.665583 82.7965634 178.409376 76.8884788C174.550718 81.0533349 168.745583 83.5694232 162.074393 83.5694232 147.673027 83.5694232 137.426148 72.6291621 137.426148 57.1419085 137.426148 41.5559006 147.673027 30.7143937 162.074393 30.7143937 168.745583 30.7143937 174.542144 33.230482 178.409376 37.3953381L179.665583 31.5130156 190.881413 31.5130156ZM178.315053 57.6485611 178.315053 56.6781925C178.315053 47.4854534 171.455218 42.3545225 164.102332 42.3545225 155.88768 42.3545225 149.992509 48.7434976 149.992509 57.1633768 149.992509 65.583256 155.88768 71.9722311 164.102332 71.9722311 171.450931 71.9507628 178.315053 66.8241255 178.315053 57.6270927L178.315053 57.6485611Z"></path></svg>`

let this_season = '2022-23'

var app = new Vue({
    el: '#app',
    data: {
        ready: false,
        loading: false,
        taking_screenshot: false,
        cup_list: undefined,
        team_id: undefined,
        league_id: undefined,
        cup_id: undefined,
        cup_info: undefined,
        graphstyle: 'ucl',
        use_player_names: false,
        start_gw_override: 34,
        earliest: 33
    },
    computed: {
        demo() {
            
        },
        league_name() {
            return ''
        }
    },
    methods: {
        reset() {
            this.ready = false
            this.loading = false
            this.taking_screenshot = false
            this.cup_list = undefined
            this.team_id = undefined
            this.league_id = undefined
            this.cup_id = undefined
            this.cup_info = undefined
            this.start_gw_override = 34
        },
        show_cup_popup() {
            app.reset()
            app.loading = true
            fetch_player_info().then((d) => {
                app.loading = false
                app.cup_list = d.body.leagues.classic.filter(i => i.has_cup)
                $("#cup-modal").modal('show')
            })
        },
        load_cup(league_id, cup_id) {
            this.league_id = league_id
            this.cup_id = cup_id
            $("#cup-modal").modal('hide')
            this.loading = true
            fetch_cup_info(league_id, cup_id).then((d) => {
                app.cup_info = d.body
                app.loading = false
                app.ready = true
                draw_bracket()
            })
        },
        download() {
            app.taking_screenshot = true

            setTimeout(() => {
                var node = document.getElementById('draw_area');
                node.style['transform-origin'] = 'top left'
                
                let ratio = 2400 / node.clientWidth
                node.style.transform = `scale(${ratio})`
                // node.style.width = '1600px'
                // node.style['background'] = 'linear-gradient(135deg, #963cfe 0%, #04f0fe 50%)'
                
                domtoimage
                    .toJpeg(node, {'quality': 0.98, 'width': node.clientWidth * ratio, 'height': node.clientHeight * ratio}, copyDefaultStyles=true)
                    .then(function (dataUrl) {
                        var img = new Image();
                        img.src = dataUrl;
                        var link = document.createElement('a');
                        link.href = dataUrl;
                        let download_name = app.cup_id + ".jpg"
                        link.download = download_name; // 'download.jpg';
                        document.body.appendChild(link);
                        setTimeout(() => {
                            link.click();
                            document.body.removeChild(link);
                            node.style.transform = ''
                            node.style['transform-origin'] = 'top'
                            // node.style['background'] = 'linear-gradient(135deg, #963cfe 0%, #04f0fe 100%)'
                            app.taking_screenshot = false
                        }, 300);
                    })
                    .catch(function (error) {
                        console.error('oops, something went wrong!', error);
                    });
            }, 100)
        }
    }
})

function draw_bracket() {
    $("#draw_area").empty()
    if (_.isEmpty(app.cup_info)) { return }

    // data
    let cup_data = _.cloneDeep(app.cup_info)
    let my_id = app.team_id

    // let first_gw = cup_data.status.qualification_event
    
    // we don't have data earlier than 33
    app.earliest = Math.max(33, cup_data.status.qualification_event + 1)
    if (app.start_gw_override < app.earliest) {
        app.start_gw_override = app.earliest
    }

    // let first_gw = Math.max(34, cup_data.status.qualification_event)
    let first_gw = parseInt(app.start_gw_override)

    let gw_range = _.range(39,first_gw-1,-1)
    let number_of_teams = _.fromPairs(gw_range.map((i,j) => [i, 2**j]))
    let number_of_games = _.fromPairs(gw_range.map((i,j) => [i, j > 1 ? 2**(j-1) : 1]))
    let is_played = _.fromPairs(gw_range.map(i => [i, (cup_data.results[i]?.results.length || 0) > 0]))
    
    let get_y_pos = (gw, i) => {
        if (gw==39) {
            return 1/2
        }
        else if (gw==first_gw) {
            return (i+1)/(number_of_games[gw]+1)
        }
        else {
            let c = 2 ** (gw-first_gw)
            let k = c*i
            let s = _.sum(_.range(k+1,k+c+1))/c
            return s / (number_of_games[first_gw]+1)
        }
    }

    let gw_titles = {
        '39': {'title': 'Winner'},
        '38': {'title': 'Final'},
        '37': {'title': 'Semi-Final'},
        '36': {'title': 'Quarter-Final'},
        '35': {'title': 'Round of 16'},
        '34': {'title': 'Round of 32'},
        '33': {'title': 'Round of 64'},
        '32': {'title': 'Round of 128'},
    }

    let gw_games = (gw) => {
        if (is_played[gw]) {
            return cup_data.results[gw].results
        }
        else {
            return _.range(number_of_games[gw]).map(i => {
                return {'entry_1': '', 'entry_2': '', 'event': gw}
            })
        }
    }

    // reorder games
    // find latest GW with games first
    let last_played_gw = 39
    for (let gw of _.range(39, first_gw-1, -1)) {
        if (cup_data.results?.[gw]?.results?.length > 0) {
            last_played_gw = gw;
            break;
        }
    }
    if (last_played_gw == 39) {
        last_played_gw = first_gw
    }
    let player_order = {}
    let id_cnt = 1

    for (let gw of _.range(last_played_gw, first_gw-1, -1)) {
        let games = cup_data.results?.[gw]?.results || []

        if (gw < last_played_gw) {
            games.forEach((p, i) => {
                let match = (cup_data.results?.[gw+1]?.results || []).find(i => p.entry_1_entry == i.entry_1_entry || p.entry_2_entry == i.entry_1_entry)
                if (match) {
                    p.order_kpi = match.gw_order
                }
                let match2 = (cup_data.results?.[gw+1]?.results || []).find(i => p.entry_1_entry == i.entry_2_entry || p.entry_2_entry == i.entry_2_entry)
                if (match2) {
                    p.order_kpi = match2.gw_order + 0.5
                }
            })

            cup_data.results[gw].results = _.orderBy(cup_data.results[gw].results, 'order_kpi', 'asc')
        }
        // for (let game of games) {
        //     let home_order = undefined
        //     if (player_order[game.entry_1_entry]) {
        //         home_order = player_order[game.entry_1_entry]
        //         game.entry_1_order = home_order
        //     }
        //     else {
        //         game.entry_1_order = id_cnt
        //         player_order[game.entry_1_entry] = id_cnt
        //         home_order = id_cnt + 0
        //         id_cnt = id_cnt + 1
        //     }
        //     if (game.is_bye) {
        //         game.game_order = home_order
        //     }
        //     else {
        //         let away_order = undefined
        //         if (player_order[game.entry_2_entry]) {
        //             away_order = player_order[game.entry_2_entry]
        //             game.entry_2_order = away_order
        //         }
        //         else {
        //             game.entry_2_order = id_cnt
        //             player_order[game.entry_2_entry] = id_cnt
        //             away_order = id_cnt + 0
        //             id_cnt = id_cnt + 1
        //         }
        //         let game_order = Math.min(home_order, away_order)
        //         game.game_order = game_order
        //     }
            
        // }

        // cup_data.results[gw].results = _.orderBy(cup_data.results[gw].results, 'game_order', 'asc')
        cup_data.results[gw].results.forEach((p,i) => {
            p.gw_order = i
        })
    }
    

    // svg

    let raw_width = 1200
    let raw_height = 900

    let margin = { top: 0, left: 0,  bottom: 0, right: 0 },
            width = raw_width - margin.left - margin.right,
            height = raw_height - margin.top - margin.bottom;

    const svg_actual = d3.select("#draw_area")
        .append("svg")
        .attr("viewBox", `0 0  ${(raw_width)} ${(raw_height)}`)

    const svg = svg_actual.append('g')
        .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");

    let plot_gap = {top: 70, bottom: 100, left: 10, right: 10}
    let plot_width = width - plot_gap.left - plot_gap.right
    let plot_height = height - plot_gap.top - plot_gap.bottom

    let bg_layer = svg.append('g')
    const plot_svg = svg.append('g')
    .attr("transform",
        "translate(" + plot_gap.left + "," + plot_gap.top + ")");

    let arrow_layer = plot_svg.append('g')
    let box_layer = plot_svg.append('g')

    // background
    bg_layer
        .append("foreignObject")
        .attr("x", 0)
        .attr("y", 0)
        .attr("width", raw_width)
        .attr("height", raw_height)
        .html(
        `
            <img src="static/img/bg/${app.graphstyle}.jpg" style="width: 100%; height: 100%; object-fit: cover;"  />
        `)

    bg_layer
        .append('rect')
        .attr('fill', '#0000004f')
        .attr('stroke', 'none')
        .attr('x', plot_gap.left)
        .attr('y', plot_gap.top)
        // .attr('x', (d,i) => x_main(d.event))
        // .attr('y', (d,i) => y_cont( (i+1) / (number_of_games[d.event] + 1)) - y_ref.bandwidth()/2)
        .attr('width', plot_width)
        .attr('height', plot_height)

    // title
    svg
        .append('text')
        .attr("x", width/2)
        .attr("y", 40)
        .attr("text-anchor", "middle")
        .attr("alignment-baseline", "middle")
        .attr("dominant-baseline", "middle")
        .style("fill", "white")
        .style("font-size", "18pt")
        .text(cup_data.status.name)

    // version
    svg
        .append('text')
        .attr("x", width-10)
        .attr("y", 10)
        .attr("text-anchor", "end")
        .attr("alignment-baseline", "hanging")
        .attr("dominant-baseline", "hanging")
        .style("fill", "black")
        .style("fill-opacity", "0.5")
        .style("font-size", "6pt")
        .text("v1.2")

    signature_theme = {
        'fpl': '#37003c',
        'ucl': '#101d3b',
        'wc': '#78632b'
    }


    // signature
    svg
        .append("foreignObject")
        .attr("x", 0)
        .attr("y", height-40)
        .attr("width", width)
        .attr("height", 40)
        .html(`
            <div id="signature">
                <div style="background-color: ${signature_theme[app.graphstyle]}">
                    <span>Data by Official FPL. Tool by <i style="color: #26a7de;" class="fab fa-twitter"></i> sertalpbilal and <i style="color: #26a7de;" class="fab fa-twitter"></i> FPL_Spaceman 👨‍🚀.</span><br>
                    https://sertalpbilal.github.io/fpl-cup/
                </div>
            </div>
        `)

    svg
        .append("foreignObject")
        .attr("x", 0)
        .attr("y", height-90)
        .attr("width", width)
        .attr("height", 50)
        .html(`
            <div id="" class="d-flex">
                <div id="fpl_logo">${fpl_logo}</div>
            </div>
        `)


    // axis
    let x_main = d3.scaleBand().domain(gw_range).range([plot_width, 0]).paddingInner(0.15).paddingOuter(0.15)
    let y_axis = {}
    for (let gw of gw_range) {
        y_axis[gw] = d3.scaleBand().domain(_.range(number_of_games[gw]+1)).range([80, plot_height]).paddingInner(0.2).paddingOuter(0)
    }
    let y_ref = y_axis[first_gw]
    let y_cont = d3.scaleLinear().domain([0,1]).range([80, plot_height])

    // plot

    // gw-titles
    let title_g = plot_svg.append('g')
    let gw_markers = title_g.selectAll().data(gw_range).enter()
    gw_markers
        .append('text')
        .attr("x", d => x_main(d) + x_main.bandwidth()/2)
        .attr("y", 40)
        .attr("text-anchor", "middle")
        .attr("alignment-baseline", "middle")
        .attr("dominant-baseline", "middle")
        .style("fill", "white")
        .text(d => gw_titles[d].title)

    gw_markers
        .append('text')
        .attr("x", d => x_main(d) + x_main.bandwidth()/2)
        .attr("y", 60)
        .attr("text-anchor", "middle")
        .attr("alignment-baseline", "middle")
        .attr("dominant-baseline", "middle")
        .style("fill", "#72bfff")
        .text(d => d < 39 ? "GW" + d : '')

    // boxes
    let box_g = box_layer.append('g')
    let box_gw = box_g.selectAll().data(gw_range).enter()
    let box = box_gw.selectAll().data(d => gw_games(d)).enter()

    let single_box = box.append('g')
        // .attr("transform", (d,i) => `translate(${x_main(d.event)},${y_cont( (i+1) / (number_of_games[d.event] + 1)) - y_ref.bandwidth()/2})`)
        .attr("transform", (d,i) => `translate(${x_main(d.event)},${y_cont( get_y_pos(d.event, i)) - y_ref.bandwidth()/2})`)

    let text_size = first_gw < 34 ? '5pt' : '8pt'

    single_box
        .append('rect')
        // .attr('fill', '#00000088')
        .attr('fill', '#000000ad')
        .attr('stroke', 'black')
        .attr('stroke-width', '0.5px')
        .style('filter', 'blur(0px)')
        .attr('x', 0)
        .attr('y', 0)
        // .attr('x', (d,i) => x_main(d.event))
        // .attr('y', (d,i) => y_cont( (i+1) / (number_of_games[d.event] + 1)) - y_ref.bandwidth()/2)
        .attr('width', x_main.bandwidth())
        .attr('height', d => y_ref.bandwidth())

    single_box
        .filter(d => d.event < 39)
        .append("line")
        .attr("stroke", "gray")
        .attr("x1", 0) 
        .attr("y1", y_ref.bandwidth()/2)
        .attr("x2", x_main.bandwidth())
        .attr("y2", y_ref.bandwidth()/2);

    single_box
        .filter(d => d.event < 39)
        .append("line")
        .attr("stroke", "gray")
        .attr("x1", 40) 
        .attr("y1", 0)
        .attr("x2", 40)
        .attr("y2", y_ref.bandwidth());

    single_box
        .append('text')
        .attr("x", 50)
        .attr("y", y_ref.bandwidth()/4)
        .attr("text-anchor", "start")
        .attr("alignment-baseline", "middle")
        .attr("dominant-baseline", "middle")
        .style("fill", d => d.winner == null ? "white" : d.winner == d.entry_1_entry ? "white" : "gray")
        .style("font-size", text_size)
        .text(d => app.use_player_names ? d.entry_1_player_name : d.entry_1_name)
        .style('cursor', 'pointer')
        .on('click', (d,e) => { 
            window.open(`https://fantasy.premierleague.com/entry/${e.entry_1_entry}/history`, '_blank')
        })

    single_box
        .append('text')
        .attr("x", 50)
        .attr("y", y_ref.bandwidth()*3/4)
        .attr("text-anchor", "start")
        .attr("alignment-baseline", "middle")
        .attr("dominant-baseline", "middle")
        .style("fill", d => d.winner == null ? "white" : d.winner == d.entry_2_entry ? "white" : "gray")
        .style("font-size", text_size)
        .text(d => app.use_player_names ? d.entry_2_player_name : d.entry_2_name)
        .style('cursor', 'pointer')
        .on('click', (d,e) => { 
            window.open(`https://fantasy.premierleague.com/entry/${e.entry_2_entry}/history`, '_blank')
        })

    single_box
        .append('text')
        .attr("x", 20)
        .attr("y", y_ref.bandwidth()/4)
        .attr("text-anchor", "middle")
        .attr("alignment-baseline", "middle")
        .attr("dominant-baseline", "middle")
        .style("fill", d => d.winner == null ? "white" : d.winner == d.entry_1_entry ? "white" : "gray")
        .style("font-size", text_size)
        .text(d => d.entry_1_points)

    single_box
        .filter(d => !d.is_bye)
        .append('text')
        .attr("x", 20)
        .attr("y", y_ref.bandwidth()*3/4)
        .attr("text-anchor", "middle")
        .attr("alignment-baseline", "middle")
        .attr("dominant-baseline", "middle")
        .style("fill", d => d.winner == null ? "white" : d.winner == d.entry_2_entry ? "white" : "gray")
        .style("font-size", text_size)
        .text(d => d.entry_2_points)

    // game order for debug
    single_box
        .append('text')
        .attr("x", -5)
        .attr("y", y_ref.bandwidth()/2)
        .attr("text-anchor", "start")
        .attr("alignment-baseline", "middle")
        .attr("dominant-baseline", "middle")
        .style("fill", "white")
        .style("font-size", "8pt")
        .text(d => d.game_order)

    // lines

    let line_data = []
    for (gw of _.range(last_played_gw, first_gw-1)) {
        let games = cup_data.results[gw].results
        let prev_games = cup_data.results?.[gw-1]?.results

        if (gw <= first_gw || prev_games == undefined || prev_games.length == 0) { continue }
        for (let game of games) {
            let p1 = game.entry_1_entry
            let match = prev_games.find(i => i.entry_1_entry == p1 || i.entry_2_entry == p1)
            if (match) {
                // line_data.push({
                //     'color': game.winner == null ? 'white' : game.winner == game.entry_1_entry ? 'white': 'gray',
                //     'from': {'gw': gw-1, 'order': match.game_order, 'gw_order': match.gw_order},
                //     'to': {'gw': gw, 'order': game.game_order, 'gw_order': game.gw_order}
                // })
                line_data.push([
                    {'x': x_main(gw-1) + x_main.bandwidth(), 'y': y_cont( get_y_pos(gw-1, match.gw_order))},
                    {'x': x_main(gw), 'y': y_cont( get_y_pos(gw, game.gw_order))}
                ])
            }
            let p2 = game.entry_2_entry
            let match2 = prev_games.find(i => i.entry_1_entry == p2 || i.entry_2_entry == p2)
            if (match2) {
                // line_data.push({
                //     'color': game.winner == null ? 'white' : game.winner == game.entry_2_entry ? 'white': 'gray',
                //     'from': {'gw': gw-1, 'order': match2.game_order, 'gw_order': match2.gw_order},
                //     'to': {'gw': gw, 'order': game.game_order, 'gw_order': game.gw_order}
                // })
                line_data.push([
                    {'x': x_main(gw-1) + x_main.bandwidth(), 'y': y_cont( get_y_pos(gw-1, match2.gw_order))},
                    {'x': x_main(gw), 'y': y_cont( get_y_pos(gw, game.gw_order))}
                ])
            }
        }
    }

    let single_arrow = arrow_layer.selectAll().data(line_data).enter()

    const line = d3.line()
        .x(d => d.x)
        .y(d => d.y)
        .curve(d3.curveStep)

    single_arrow.datum(d => d)
        .append('path')
        .attr("d", line)
        .attr("stroke", "white")
        .attr("fill", "none")

    // single_arrow
    //     .append("line")
    //     .attr("stroke", 'white')
    //     .style("stroke-width", "1px")
    //     .attr("x1", d => x_main(d.from.gw) + x_main.bandwidth()) 
    //     .attr("y1", d => y_cont( get_y_pos(d.from.gw, d.from.gw_order)))
    //     .attr("x2", d => x_main(d.to.gw))
    //     .attr("y2", d => y_cont( get_y_pos(d.to.gw, d.to.gw_order)))

}

function read_local_file(url) {
    return new Promise((resolve, reject) => {
        $.ajax({
            type: "GET",
            url: url,
            async: true,
            success: function(data) {
                resolve(data);
            },
            error: function() {
                reject("No data");
            }
        });
    });
}


// let proxy = "https://cors.alpscode.com"


async function fetch_player_info(){

    let tid = document.querySelector("#tid").value
    if (tid == '') { return }

    app.team_id = tid

    return new Promise((resolve, reject) => {
        $.ajax({
            type: "GET",
            url: `https://alpscode.com/fpl-fetch/general_info?id=${tid}`,
            dataType: 'json',
            async: true,
            headers: {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Headers': "X-Requested-With",
                'Access-Control-Allow-Methods': 'GET',
                'X-Requested-With': 'XMLHttpRequest',
                'Referrer-Policy': 'no-referrer-when-downgrade'
            },
            success: function(data) {
                resolve({ body: data })
            },
            error: function(xhr, status, error) {
                reject(`Cannot get info for team ${tid}`)
            }
        });
    })

}

async function fetch_cup_info(league_id, cup_id){

    return new Promise((resolve, reject) => {
        $.ajax({
            type: "GET",
            url: `https://alpscode.com/fpl-fetch/cup_info?league_id=${league_id}&cup_id=${cup_id}`,
            dataType: 'json',
            async: true,
            headers: {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Headers': "X-Requested-With",
                'Access-Control-Allow-Methods': 'GET',
                'X-Requested-With': 'XMLHttpRequest',
                'Referrer-Policy': 'no-referrer-when-downgrade'
            },
            success: function(data) {
                resolve({ body: data })
            },
            error: function(xhr, status, error) {
                reject(`Cannot get info for cup ${league_id} ${cup_id}`)
            }
        });
    })

}

$(document).ready(() => {
    // read_local_file("data/demo.json").then((d) => {
    //     app.cup_info = d
    //     app.team_id = '32409'
    //     app.league_id = 169607
    //     app.cup_id = 2577731
    //     app.ready = true
    //     setTimeout(() => {
    //         draw_bracket()
    //     })
    // })
})
